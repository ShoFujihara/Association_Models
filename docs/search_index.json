[["1-Introduction.html", "はじめに シリーズ編者による序文 度数，行変数，列変数のデータからクロス表を作成 練習問題 参考文献", " はじめに シリーズ編者による序文 独立性の検定 # パッケージの読み込み library(tidyverse) library(magrittr) library(gnm) 精神衛生と親の社会経済的地位（SES）に関するミッドタウン・マンハッタンデータ（the Midtown Manhattan data） 元データについて，ここではクロス表（のようにみえる）形式で入力する．これをFreqとする． 実際は横に長い一行のベクトルなので，matrix関数を用いて，行列に変換する．これをtabする．nrowは行カテゴリ数，ncolは列カテゴリ数である．byrow = TRUEとすることを忘れないように注意． # 元データの入力 Freq &lt;- c( 64, 94, 58, 46, 57, 94, 54, 40, 57, 105, 65, 60, 72, 141, 77, 94, 36, 97, 54, 78, 21, 71, 54, 71) # データを表形式に変換 tab &lt;- matrix(Freq, nrow = 6, ncol = 4, byrow = TRUE) 初歩的なクロス表の分析はここで作成されたtabに対して行う．tabを確認してみよう． as.tableによってクラスをmatrixからtableに変えることもできる．分析はどちらであっても問題ない． # 観察度数 tab ## [,1] [,2] [,3] [,4] ## [1,] 64 94 58 46 ## [2,] 57 94 54 40 ## [3,] 57 105 65 60 ## [4,] 72 141 77 94 ## [5,] 36 97 54 78 ## [6,] 21 71 54 71 # クラスをmatrixからtableに変える tab &lt;- as.table(tab) tab ## A B C D ## A 64 94 58 46 ## B 57 94 54 40 ## C 57 105 65 60 ## D 72 141 77 94 ## E 36 97 54 78 ## F 21 71 54 71 tabに対してカイ2乗検定を行う． # 表に対してカイ2乗検定を行う chisq.test(tab) ## ## Pearson&#39;s Chi-squared test ## ## data: tab ## X-squared = 45.985, df = 15, p-value = 5.346e-05 chisq.test(tab)からは他にもいろいろな情報が得られる． ヘルプ?chisq.testかnames関数で確認してみよう． names(chisq.test(tab)) ## [1] &quot;statistic&quot; &quot;parameter&quot; &quot;p.value&quot; &quot;method&quot; &quot;data.name&quot; &quot;observed&quot; ## [7] &quot;expected&quot; &quot;residuals&quot; &quot;stdres&quot; 期待度数はchisq.test(tab)$expectedとすればよい．これをtab_expectedとする． # ixの期待度数 tab_expected &lt;- chisq.test(tab)$expected tab_expected ## A B C D ## A 48.45422 95.01446 57.13494 61.39639 ## B 45.31024 88.84940 53.42771 57.41265 ## C 53.07771 104.08072 62.58675 67.25482 ## D 71.01687 139.25783 83.73976 89.98554 ## E 49.00904 96.10241 57.78916 62.09940 ## F 40.13193 78.69518 47.32169 50.85120 ixページの数式用いて，ピアソンの\\(\\chi^2\\)統計量と尤度比統計量\\(L^2\\)を求める． 自由度についてもnrowとncolを用いて計算（prod(dim(tab) -1)でもよい）． list関数は様々なもの（値，ベクトル，データ，リスト等）を並べるときに用いる． # 適合度（X2とL2） X2 &lt;- ((tab - tab_expected)^2 / tab_expected) %&gt;% sum() L2 &lt;- (tab * log(tab / tab_expected)) %&gt;% sum() * 2 df &lt;- (nrow(tab) - 1) * (ncol(tab) - 1) # df &lt;- prod(dim(tab) -1) list(&quot;自由度&quot; = df, &quot;ピアソンのカイ2乗統計量&quot; = X2, &quot;尤度比統計量&quot; = L2) ## $自由度 ## [1] 15 ## ## $ピアソンのカイ2乗統計量 ## [1] 45.98526 ## ## $尤度比統計量 ## [1] 47.41785 一様連関モデル ページixの一様連関モデルを再現する． データの準備 多元表の分析はクロス表ではなく，度数，行変数，列変数からなるデータを作成して行う．度数については先程作成したFreqを使う． glによって度数に対応するカテゴリを作成する． このような形にすることで柔軟なモデリングを行うことができる． なおgnmパッケージにはmentalHealthというデータがあるのでそれを用いてもよい． # 度数のベクトル Freq ## [1] 64 94 58 46 57 94 54 40 57 105 65 60 72 141 77 94 36 97 54 ## [20] 78 21 71 54 71 # 行変数 PSES &lt;- gl(n = 6, k = 4) PSES ## [1] 1 1 1 1 2 2 2 2 3 3 3 3 4 4 4 4 5 5 5 5 6 6 6 6 ## Levels: 1 2 3 4 5 6 # 列変数 MHS &lt;- gl(n = 4, k = 1, length = 24) MHS ## [1] 1 2 3 4 1 2 3 4 1 2 3 4 1 2 3 4 1 2 3 4 1 2 3 4 ## Levels: 1 2 3 4 # 度数，行変数，列変数からなるデータを作成 freq_tab_intro &lt;- tibble(Freq, PSES, MHS) # データの確認 freq_tab_intro ## # A tibble: 24 x 3 ## Freq PSES MHS ## &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; ## 1 64 1 1 ## 2 94 1 2 ## 3 58 1 3 ## 4 46 1 4 ## 5 57 2 1 ## 6 94 2 2 ## 7 54 2 3 ## 8 40 2 4 ## 9 57 3 1 ## 10 105 3 2 ## # … with 14 more rows 独立モデル この形式のデータに対して，独立モデルによる分析を行う．これは先程の独立性の検定と同じ結果となる． %&gt;%はパイプ演算子である．freq_tab_introというデータに対して，gnmを適用する．gnm内でdata = .となっているがこれはdata = freq_tab_introとすることに等しい． こうして得られた分析の結果をOとしている． # 独立モデル O &lt;- freq_tab_intro %&gt;% gnm(Freq ~ PSES + MHS, family = poisson, data = .) 結果はOあるいはsummary(O)で確認できる． # 結果の表示 O ## ## Call: ## gnm(formula = Freq ~ PSES + MHS, family = poisson, data = .) ## ## Coefficients: ## (Intercept) PSES2 PSES3 PSES4 PSES5 PSES6 ## 3.88062 -0.06709 0.09114 0.38230 0.01139 -0.18845 ## MHS2 MHS3 MHS4 ## 0.67341 0.16480 0.23673 ## ## Deviance: 47.41785 ## Pearson chi-squared: 45.98526 ## Residual df: 15 summary(O) ## ## Call: ## gnm(formula = Freq ~ PSES + MHS, family = poisson, data = .) ## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -3.3260 -0.7806 0.1028 0.5343 2.6643 ## ## Coefficients: ## Estimate Std. Error z value Pr(&gt;|z|) ## (Intercept) 3.88062 0.08045 48.238 &lt; 2e-16 *** ## PSES2 -0.06709 0.08887 -0.755 0.45034 ## PSES3 0.09114 0.08545 1.067 0.28615 ## PSES4 0.38230 0.08013 4.771 1.83e-06 *** ## PSES5 0.01139 0.08712 0.131 0.89603 ## PSES6 -0.18845 0.09179 -2.053 0.04007 * ## MHS2 0.67341 0.07013 9.602 &lt; 2e-16 *** ## MHS3 0.16480 0.07759 2.124 0.03367 * ## MHS4 0.23673 0.07634 3.101 0.00193 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## (Dispersion parameter for poisson family taken to be 1) ## ## Residual deviance: 47.418 on 15 degrees of freedom ## AIC: 209.59 ## ## Number of iterations: 4 # 適合度（X2とL2） tab_expected_O &lt;- O$fitted.values # 行と列のカテゴリ数 I &lt;- freq_tab_intro$PSES %&gt;% unique() %&gt;% length() J &lt;- freq_tab_intro$MHS %&gt;% unique() %&gt;% length() df_0 &lt;- (I - 1) * (J - 1) X2_O &lt;- ((Freq - tab_expected_O)^2 / tab_expected_O) %&gt;% sum() L2_O &lt;- (Freq * log(Freq / tab_expected_O)) %&gt;% sum() * 2 list(&quot;自由度&quot; = df_0, &quot;ピアソンのカイ2乗統計量&quot; = X2_O, &quot;尤度比統計量&quot; = L2_O) ## $自由度 ## [1] 15 ## ## $ピアソンのカイ2乗統計量 ## [1] 45.98526 ## ## $尤度比統計量 ## [1] 47.41785 Residual deviance: 47.418 on 15 degrees of freedomとなっており，先程の分析と適合度は一致する． 一様連関モデル 次に一様連関モデル（Uniform association model）による分析を行う． mutate関数でPSESを整数にしたものをRscore，MHSを整数にしたものをCscoreとして新たに変数を作成している． 変数の追加されたfreq_tab_introデータに対して，一様連関モデルによる分析をgnmパッケージで行う． 独立モデルとの違いは，作成した整数スコアの積Rscore*Cscoreがモデルに追加されているだけである． # 行変数と列変数を連続した整数値とする freq_tab_intro %&lt;&gt;% mutate(Rscore = as.integer(PSES), Cscore = as.integer(MHS)) # 一様連関モデル U &lt;- freq_tab_intro %&gt;% gnm(Freq ~ PSES + MHS + Rscore*Cscore, family = poisson, data = .) # 結果の表示 summary(U) ## ## Call: ## gnm(formula = Freq ~ PSES + MHS + Rscore * Cscore, family = poisson, ## data = .) ## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -1.2663 -0.3285 0.2025 0.3912 1.0820 ## ## Coefficients: ## Estimate Std. Error z value Pr(&gt;|z|) ## (Intercept) 4.08817 0.08299 49.259 &lt; 2e-16 *** ## PSES2 -0.27661 0.09445 -2.929 0.003405 ** ## PSES3 -0.33651 0.10841 -3.104 0.001909 ** ## PSES4 -0.27228 0.13155 -2.070 0.038472 * ## PSES5 -0.87902 0.16903 -5.200 1.99e-07 *** ## PSES6 -1.32360 0.20946 -6.319 2.63e-10 *** ## MHS2 0.37892 0.08360 4.533 5.82e-06 *** ## MHS3 -0.44530 0.12489 -3.566 0.000363 *** ## MHS4 -0.70991 0.17460 -4.066 4.79e-05 *** ## Rscore 0.00000 NA NA NA ## Cscore 0.00000 NA NA NA ## Rscore:Cscore 0.09069 0.01501 6.043 1.51e-09 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## (Dispersion parameter for poisson family taken to be 1) ## ## Std. Error is NA where coefficient has been constrained or is unidentified ## ## Residual deviance: 9.8951 on 14 degrees of freedom ## AIC: 174.07 ## ## Number of iterations: 3 # 適合度（X2とL2） tab_expected_U &lt;- U$fitted.values df_U &lt;- (I - 1)*(J - 1) - 1 X2_U &lt;- ((Freq - tab_expected_U)^2 / tab_expected_U) %&gt;% sum() L2_U &lt;- (Freq * log(Freq / tab_expected_U)) %&gt;% sum() * 2 list(&quot;自由度&quot; = df_U, &quot;ピアソンのカイ2乗統計量&quot; = X2_U, &quot;尤度比統計量&quot; = L2_U) ## $自由度 ## [1] 14 ## ## $ピアソンのカイ2乗統計量 ## [1] 9.731848 ## ## $尤度比統計量 ## [1] 9.895123 結果がixページと一致することを確認してほしい． 度数，行変数，列変数のデータからクロス表を作成 度数，行変数，列変数のデータからクロス表を作成するにはxtabs関数を用いる． freq_tab_intro %&gt;% xtabs(Freq ~ PSES + MHS, data = .) ## MHS ## PSES 1 2 3 4 ## 1 64 94 58 46 ## 2 57 94 54 40 ## 3 57 105 65 60 ## 4 72 141 77 94 ## 5 36 97 54 78 ## 6 21 71 54 71 Rに初めから準備されているTitanicデータは，多少特殊な集計がされているが，これにdata.frame関数を適用すると，集計データになる．これに対してxtabs関数を用いればクロス表を簡単に作成できる． data.frame(Titanic) %&gt;% xtabs(Freq ~ Class + Survived, data = .) ## Survived ## Class No Yes ## 1st 122 203 ## 2nd 167 118 ## 3rd 528 178 ## Crew 673 212 data.frame(Titanic) %&gt;% xtabs(Freq ~ Sex + Survived, data = .) ## Survived ## Sex No Yes ## Male 1364 367 ## Female 126 344 data.frame(Titanic) %&gt;% xtabs(Freq ~ Age + Survived, data = .) ## Survived ## Age No Yes ## Child 52 57 ## Adult 1438 654 練習問題 せっかくデータを入力したので，このデータを使ってGoodman（1979）の表5A，表5B，表5Cの結果を再現しよう． 分析方法については第2章のプログラムを参考にしてほしい． 参考文献 Goodman, Leo A. 1979. “Simple Models for the Analysis of Association in Cross-Classifications Having Ordered Categories.” Journal of the American Statistical Association 74(367):537–52. "]]
